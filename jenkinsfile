
pipeline {
    agent any

    tools {
        maven 'Maven 3.9.5'
        jdk 'JDK 17'
    }

    environment {
        MAVEN_OPTS = '-Xmx3072m -XX:MaxPermSize=512m'
        PROJECT_NAME = 'Radio BDD Automations Tests'
        TIMESTAMP = new Date().format('yyyy-MM-dd_HH-mm-ss')
        CUCUMBER_REPORTS = 'target/cucumber-reports'
        GIT_COMMIT_MSG = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
        GIT_AUTHOR = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
    }

    stages {
        stage('Initialize') {
            steps {
                script {
                    echo """
                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                        â•‘      Test Automation Start       â•‘
                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        ğŸš€ Framework: Cucumber BDD
                        ğŸ“± Platforms: Web & Mobile
                        ğŸ”§ Build Tool: Maven
                    """
                }

                // Clean workspace and checkout code
                cleanWs()
                checkout scm
            }
        }

        stage('Build & Dependencies') {
            steps {
                script {
                    echo """
                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                        â•‘    Installing Dependencies       â•‘
                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                }

                // Clean install with checkstyle verification
                sh """
                    mvn clean install -DskipTests
                    mvn checkstyle:check
                """
            }
        }

        stage('Test Execution') {
            steps {
                script {
                    try {
                        echo """
                            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                            â•‘        Running Tests             â•‘
                            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        """

                        // Run tests with parallel execution
                        sh """
                            mvn test \
                            -Dmaven.test.failure.ignore=true \
                            -Dparallel=methods \
                            -DthreadCount=3 \
                            -Dcucumber.filter.tags="@web or @mobile" \
                            -Dcucumber.plugin="json:target/cucumber.json,html:target/cucumber-reports/html" \
                            | tee execution.log
                        """

                        // Generate Cucumber Reports
                        sh 'mvn verify -DskipTests'

                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
            post {
                always {
                    // Archive test results and reports
                    archiveArtifacts artifacts: """
                        target/cucumber-reports/**/*,
                        target/cucumber.json,
                        target/screenshots/**/*,
                        execution.log
                    """, allowEmptyArchive: true

                    // Publish test results
                    cucumber buildStatus: 'UNSTABLE',
                            fileIncludePattern: '**/cucumber.json',
                            jsonReportDirectory: 'target'
                }
            }
        }
    }

    post {
        always {
            script {
                def testResults = ""
                if (fileExists('execution.log')) {
                    testResults = readFile('execution.log').trim()
                }

                echo """
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘       Test Execution Summary     â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    ğŸ·ï¸ Project: ${PROJECT_NAME}
                    â±ï¸ Completed: ${new Date().format('dd/MM/yyyy HH:mm:ss')}
                    ğŸ‘¤ Triggered by: ${GIT_AUTHOR}
                    ğŸ“ Commit message: ${GIT_COMMIT_MSG}

                    ğŸ“Š Test Results:
                    ===============
                    ${testResults}

                    ğŸ“‹ Reports:
                    - Cucumber HTML Report: ${WORKSPACE}/target/cucumber-reports/html/index.html
                    - JSON Report: ${WORKSPACE}/target/cucumber.json

                    ${currentBuild.result == 'SUCCESS' ? 'âœ… Build Status: SUCCESS' : 'âŒ Build Status: FAILED'}
                """
            }
            // Cleanup workspace
            cleanWs()
        }
        success {
            echo """
                âœ¨ Test execution completed successfully!
                ğŸ” Check the Cucumber reports for detailed results.
            """
        }
        failure {
            echo """
                âŒ Test execution failed!
                ğŸ” Please check the logs and reports for details.
            """
        }
    }
}
